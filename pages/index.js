import { useContext, useEffect } from "react";
import { CategoriesContext } from "../context/CategoriesContext";
import styled from "styled-components";
import styles from "../styles/Home.module.css";

import Head from "next/head";

import Filter from "../components/Filter";
import HeroCarousel from "../components/Hero/index";
import Continue from "../components/Continue";
import Category from "../components/Category";
import Footer from "../components/Footer";
import Calendars from "../components/Calendars";
import Layout from "../components/Layout";
import Trending from "../components/Trending/index";

export default function Home({ categories, resources, hero, topics }) {
  // Set categories to context on component load
  const { setCategories } = useContext(CategoriesContext);
  useEffect(() => {
    setCategories(categories);
  }, [setCategories, categories]);

  return (
    <Wrapper className={styles.container}>
      <Head>
        <title>Power over Pain | Surmonter sa douleur</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main className={styles.main}>
        <Layout categories={categories} />
        <HeroCarousel hero={hero} />
        <Trending />
        <Filter resources={resources} topics={topics} />
        <Continue />
        <Category categories={categories} resources={resources} />
        <Calendars />
        <Footer />
      </main>
    </Wrapper>
  );
}

// Fetches all data (server-side)
export async function getStaticProps() {
  return Promise.all([
    // Categories (in order)
    fetch(
      `https://cdn.contentful.com/spaces/${process.env.CONTENTFUL_SPACE_ID}/environments/master/entries?access_token=${process.env.CONTENTFUL_ACCESS_TOKEN}&content_type=categories&locale=en-CA&order=fields.categoryOrderNumber`
    ),
    // All resources (in order)
    fetch(
      `https://cdn.contentful.com/spaces/${process.env.CONTENTFUL_SPACE_ID}/environments/master/entries?access_token=${process.env.CONTENTFUL_ACCESS_TOKEN}&content_type=resourceBilingual&order=fields.resourceOrderNumber`
    ),
    // Hero carousel content
    fetch(
      `https://cdn.contentful.com/spaces/${process.env.CONTENTFUL_SPACE_ID}/environments/master/entries?access_token=${process.env.CONTENTFUL_ACCESS_TOKEN}&content_type=carouselImage`
    ),
    // Banner content
    // Topics for filter
    fetch(
      `https://cdn.contentful.com/spaces/${process.env.CONTENTFUL_SPACE_ID}/environments/master/entries/4vl1MIDfI3SUxVb7w9YHBf?access_token=${process.env.CONTENTFUL_ACCESS_TOKEN}`
    ),
  ])
    .then(([categoriesRes, resourcesRes, heroRes, topicsRes]) =>
      Promise.all([
        categoriesRes.json(),
        resourcesRes.json(),
        heroRes.json(),
        topicsRes.json(),
      ])
    )
    .then(([categoriesJson, resourcesJson, heroJson, topicsJson]) => {
      return {
        props: {
          categories: categoriesJson,
          resources: resourcesJson,
          hero: heroJson,
          topics: topicsJson,
        },
      };
    });
}

const Wrapper = styled.div`
  display: flex;
  flex-direction: column;
  width: 100%;
  background: rgb(143, 189, 226);
  background: rgb(182, 216, 244);
  background: linear-gradient(
    337deg,
    rgba(182, 216, 244, 1) 0%,
    rgba(75, 112, 201, 1) 97%
  );
`;
